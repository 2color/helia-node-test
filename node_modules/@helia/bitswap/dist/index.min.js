(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.HeliaBitswap = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var HeliaBitswap=(()=>{var In=Object.create;var Ve=Object.defineProperty;var Bn=Object.getOwnPropertyDescriptor;var Nn=Object.getOwnPropertyNames;var Cn=Object.getPrototypeOf,Un=Object.prototype.hasOwnProperty;var _t=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),C=(n,e)=>{for(var t in e)Ve(n,t,{get:e[t],enumerable:!0})},Ir=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Nn(e))!Un.call(n,s)&&s!==t&&Ve(n,s,{get:()=>e[s],enumerable:!(r=Bn(e,s))||r.enumerable});return n};var Br=(n,e,t)=>(t=n!=null?In(Cn(n)):{},Ir(e||!n||!n.__esModule?Ve(t,"default",{value:n,enumerable:!0}):t,n)),Pn=n=>Ir(Ve({},"__esModule",{value:!0}),n);var vn=_t((Re,Et)=>{(function(n,e){"use strict";var t={version:"3.0.0",x86:{},x64:{},inputValidation:!0};function r(o){if(!Array.isArray(o)&&!ArrayBuffer.isView(o))return!1;for(var l=0;l<o.length;l++)if(!Number.isInteger(o[l])||o[l]<0||o[l]>255)return!1;return!0}function s(o,l){return(o&65535)*l+(((o>>>16)*l&65535)<<16)}function i(o,l){return o<<l|o>>>32-l}function a(o){return o^=o>>>16,o=s(o,2246822507),o^=o>>>13,o=s(o,3266489909),o^=o>>>16,o}function c(o,l){o=[o[0]>>>16,o[0]&65535,o[1]>>>16,o[1]&65535],l=[l[0]>>>16,l[0]&65535,l[1]>>>16,l[1]&65535];var h=[0,0,0,0];return h[3]+=o[3]+l[3],h[2]+=h[3]>>>16,h[3]&=65535,h[2]+=o[2]+l[2],h[1]+=h[2]>>>16,h[2]&=65535,h[1]+=o[1]+l[1],h[0]+=h[1]>>>16,h[1]&=65535,h[0]+=o[0]+l[0],h[0]&=65535,[h[0]<<16|h[1],h[2]<<16|h[3]]}function u(o,l){o=[o[0]>>>16,o[0]&65535,o[1]>>>16,o[1]&65535],l=[l[0]>>>16,l[0]&65535,l[1]>>>16,l[1]&65535];var h=[0,0,0,0];return h[3]+=o[3]*l[3],h[2]+=h[3]>>>16,h[3]&=65535,h[2]+=o[2]*l[3],h[1]+=h[2]>>>16,h[2]&=65535,h[2]+=o[3]*l[2],h[1]+=h[2]>>>16,h[2]&=65535,h[1]+=o[1]*l[3],h[0]+=h[1]>>>16,h[1]&=65535,h[1]+=o[2]*l[2],h[0]+=h[1]>>>16,h[1]&=65535,h[1]+=o[3]*l[1],h[0]+=h[1]>>>16,h[1]&=65535,h[0]+=o[0]*l[3]+o[1]*l[2]+o[2]*l[1]+o[3]*l[0],h[0]&=65535,[h[0]<<16|h[1],h[2]<<16|h[3]]}function p(o,l){return l%=64,l===32?[o[1],o[0]]:l<32?[o[0]<<l|o[1]>>>32-l,o[1]<<l|o[0]>>>32-l]:(l-=32,[o[1]<<l|o[0]>>>32-l,o[0]<<l|o[1]>>>32-l])}function x(o,l){return l%=64,l===0?o:l<32?[o[0]<<l|o[1]>>>32-l,o[1]<<l]:[o[1]<<l-32,0]}function m(o,l){return[o[0]^l[0],o[1]^l[1]]}function A(o){return o=m(o,[0,o[0]>>>1]),o=u(o,[4283543511,3981806797]),o=m(o,[0,o[0]>>>1]),o=u(o,[3301882366,444984403]),o=m(o,[0,o[0]>>>1]),o}t.x86.hash32=function(o,l){if(t.inputValidation&&!r(o))return e;l=l||0;for(var h=o.length%4,E=o.length-h,f=l,d=0,g=3432918353,b=461845907,y=0;y<E;y=y+4)d=o[y]|o[y+1]<<8|o[y+2]<<16|o[y+3]<<24,d=s(d,g),d=i(d,15),d=s(d,b),f^=d,f=i(f,13),f=s(f,5)+3864292196;switch(d=0,h){case 3:d^=o[y+2]<<16;case 2:d^=o[y+1]<<8;case 1:d^=o[y],d=s(d,g),d=i(d,15),d=s(d,b),f^=d}return f^=o.length,f=a(f),f>>>0},t.x86.hash128=function(o,l){if(t.inputValidation&&!r(o))return e;l=l||0;for(var h=o.length%16,E=o.length-h,f=l,d=l,g=l,b=l,y=0,v=0,w=0,S=0,G=597399067,ze=2869860233,He=951274213,qe=2716044179,k=0;k<E;k=k+16)y=o[k]|o[k+1]<<8|o[k+2]<<16|o[k+3]<<24,v=o[k+4]|o[k+5]<<8|o[k+6]<<16|o[k+7]<<24,w=o[k+8]|o[k+9]<<8|o[k+10]<<16|o[k+11]<<24,S=o[k+12]|o[k+13]<<8|o[k+14]<<16|o[k+15]<<24,y=s(y,G),y=i(y,15),y=s(y,ze),f^=y,f=i(f,19),f+=d,f=s(f,5)+1444728091,v=s(v,ze),v=i(v,16),v=s(v,He),d^=v,d=i(d,17),d+=g,d=s(d,5)+197830471,w=s(w,He),w=i(w,17),w=s(w,qe),g^=w,g=i(g,15),g+=b,g=s(g,5)+2530024501,S=s(S,qe),S=i(S,18),S=s(S,G),b^=S,b=i(b,13),b+=f,b=s(b,5)+850148119;switch(y=0,v=0,w=0,S=0,h){case 15:S^=o[k+14]<<16;case 14:S^=o[k+13]<<8;case 13:S^=o[k+12],S=s(S,qe),S=i(S,18),S=s(S,G),b^=S;case 12:w^=o[k+11]<<24;case 11:w^=o[k+10]<<16;case 10:w^=o[k+9]<<8;case 9:w^=o[k+8],w=s(w,He),w=i(w,17),w=s(w,qe),g^=w;case 8:v^=o[k+7]<<24;case 7:v^=o[k+6]<<16;case 6:v^=o[k+5]<<8;case 5:v^=o[k+4],v=s(v,ze),v=i(v,16),v=s(v,He),d^=v;case 4:y^=o[k+3]<<24;case 3:y^=o[k+2]<<16;case 2:y^=o[k+1]<<8;case 1:y^=o[k],y=s(y,G),y=i(y,15),y=s(y,ze),f^=y}return f^=o.length,d^=o.length,g^=o.length,b^=o.length,f+=d,f+=g,f+=b,d+=f,g+=f,b+=f,f=a(f),d=a(d),g=a(g),b=a(b),f+=d,f+=g,f+=b,d+=f,g+=f,b+=f,("00000000"+(f>>>0).toString(16)).slice(-8)+("00000000"+(d>>>0).toString(16)).slice(-8)+("00000000"+(g>>>0).toString(16)).slice(-8)+("00000000"+(b>>>0).toString(16)).slice(-8)},t.x64.hash128=function(o,l){if(t.inputValidation&&!r(o))return e;l=l||0;for(var h=o.length%16,E=o.length-h,f=[0,l],d=[0,l],g=[0,0],b=[0,0],y=[2277735313,289559509],v=[1291169091,658871167],w=0;w<E;w=w+16)g=[o[w+4]|o[w+5]<<8|o[w+6]<<16|o[w+7]<<24,o[w]|o[w+1]<<8|o[w+2]<<16|o[w+3]<<24],b=[o[w+12]|o[w+13]<<8|o[w+14]<<16|o[w+15]<<24,o[w+8]|o[w+9]<<8|o[w+10]<<16|o[w+11]<<24],g=u(g,y),g=p(g,31),g=u(g,v),f=m(f,g),f=p(f,27),f=c(f,d),f=c(u(f,[0,5]),[0,1390208809]),b=u(b,v),b=p(b,33),b=u(b,y),d=m(d,b),d=p(d,31),d=c(d,f),d=c(u(d,[0,5]),[0,944331445]);switch(g=[0,0],b=[0,0],h){case 15:b=m(b,x([0,o[w+14]],48));case 14:b=m(b,x([0,o[w+13]],40));case 13:b=m(b,x([0,o[w+12]],32));case 12:b=m(b,x([0,o[w+11]],24));case 11:b=m(b,x([0,o[w+10]],16));case 10:b=m(b,x([0,o[w+9]],8));case 9:b=m(b,[0,o[w+8]]),b=u(b,v),b=p(b,33),b=u(b,y),d=m(d,b);case 8:g=m(g,x([0,o[w+7]],56));case 7:g=m(g,x([0,o[w+6]],48));case 6:g=m(g,x([0,o[w+5]],40));case 5:g=m(g,x([0,o[w+4]],32));case 4:g=m(g,x([0,o[w+3]],24));case 3:g=m(g,x([0,o[w+2]],16));case 2:g=m(g,x([0,o[w+1]],8));case 1:g=m(g,[0,o[w]]),g=u(g,y),g=p(g,31),g=u(g,v),f=m(f,g)}return f=m(f,[0,o.length]),d=m(d,[0,o.length]),f=c(f,d),d=c(d,f),f=A(f),d=A(d),f=c(f,d),d=c(d,f),("00000000"+(f[0]>>>0).toString(16)).slice(-8)+("00000000"+(f[1]>>>0).toString(16)).slice(-8)+("00000000"+(d[0]>>>0).toString(16)).slice(-8)+("00000000"+(d[1]>>>0).toString(16)).slice(-8)},typeof Re<"u"?(typeof Et<"u"&&Et.exports&&(Re=Et.exports=t),Re.murmurHash3=t):typeof define=="function"&&define.amd?define([],function(){return t}):(t._murmurHash3=n.murmurHash3,t.noConflict=function(){return n.murmurHash3=t._murmurHash3,t._murmurHash3=e,t.noConflict=e,t},n.murmurHash3=t)})(Re)});var Ln=_t((al,kn)=>{kn.exports=vn()});var Dn=_t((ql,An)=>{An.exports=function(n){if(!n)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),r=Object.create(null);function s(i,a){t[i]=a,e++,e>=n&&(e=0,r=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||r[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),r[i]!==void 0&&(r[i]=void 0)},get:function(i){var a=t[i];if(a!==void 0)return a;if((a=r[i])!==void 0)return s(i,a),a},set:function(i,a){t[i]!==void 0?t[i]=a:s(i,a)},clear:function(){t=Object.create(null),r=Object.create(null)}}}});var Hi={};C(Hi,{createBitswap:()=>zi});var W=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};var ue=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};var Ge=class extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}};var We=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}},$e=class extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}};var U=(n,...e)=>{try{[...e]}catch{}};var q=class extends EventTarget{#e=new Map;constructor(){super(),U(1/0,this)}listenerCount(e){let t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,r){super.addEventListener(e,t,r);let s=this.#e.get(e);s==null&&(s=[],this.#e.set(e,s)),s.push({callback:t,once:(r!==!0&&r!==!1&&r?.once)??!1})}removeEventListener(e,t,r){super.removeEventListener(e.toString(),t??null,r);let s=this.#e.get(e);s!=null&&(s=s.filter(({callback:i})=>i!==t),this.#e.set(e,s))}dispatchEvent(e){let t=super.dispatchEvent(e),r=this.#e.get(e.type);return r==null||(r=r.filter(({once:s})=>!s),this.#e.set(e.type,r)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}};function Nr(n){let e=new globalThis.AbortController;function t(){e.abort();for(let i of n)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(let i of n){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function r(){for(let i of n)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}let s=e.signal;return s.clear=r,s}function F(){let n={};return n.promise=new Promise((e,t)=>{n.resolve=e,n.reject=t}),n}var Xe=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},he=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new Xe(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new Xe(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var Mt=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function fe(n={}){return Rn(t=>{let r=t.shift();if(r==null)return{done:!0};if(r.error!=null)throw r.error;return{done:r.done===!0,value:r.value}},n)}function Rn(n,e){e=e??{};let t=e.onEnd,r=new he,s,i,a,c=F(),u=async()=>{try{return r.isEmpty()?a?{done:!0}:await new Promise((E,f)=>{i=d=>{i=null,r.push(d);try{E(n(r))}catch(g){f(g)}return s}}):n(r)}finally{r.isEmpty()&&queueMicrotask(()=>{c.resolve(),c=F()})}},p=E=>i!=null?i(E):(r.push(E),s),x=E=>(r=new he,i!=null?i({error:E}):(r.push({error:E}),s)),m=E=>{if(a)return s;if(e?.objectMode!==!0&&E?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return p({done:!1,value:E})},A=E=>a?s:(a=!0,E!=null?x(E):p({done:!0})),o=()=>(r=new he,A(),{done:!0}),l=E=>(A(E),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:u,return:o,throw:l,push:m,end:A,get readableLength(){return r.size},onEmpty:async E=>{let f=E?.signal;if(f?.throwIfAborted(),r.isEmpty())return;let d,g;f!=null&&(d=new Promise((b,y)=>{g=()=>{y(new Mt)},f.addEventListener("abort",g)}));try{await Promise.race([c.promise,d])}finally{g!=null&&f!=null&&f?.removeEventListener("abort",g)}}},t==null)return s;let h=s;return s={[Symbol.asyncIterator](){return this},next(){return h.next()},throw(E){return h.throw(E),t!=null&&(t(E),t=void 0),{done:!0}},return(){return h.return(),t!=null&&(t(),t=void 0),{done:!0}},push:m,end(E){return h.end(E),t!=null&&(t(E),t=void 0),s},get readableLength(){return h.readableLength},onEmpty:E=>h.onEmpty(E)},s}var It=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.name="AbortError",this.code=t??"ABORT_ERR"}};async function O(n,e,t,r){let s=new It(r?.errorMessage,r?.errorCode);return t?.aborted===!0?Promise.reject(s):new Promise((i,a)=>{function c(){t?.removeEventListener("abort",x),n.removeEventListener(e,u),r?.errorEvent!=null&&n.removeEventListener(r.errorEvent,p)}let u=m=>{try{if(r?.filter?.(m)===!1)return}catch(A){c(),a(A);return}c(),i(m)},p=m=>{c(),a(m.detail)},x=()=>{c(),a(s)};t?.addEventListener("abort",x),n.addEventListener(e,u),r?.errorEvent!=null&&n.addEventListener(r.errorEvent,p)})}var Qe=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};var Je=class extends Error{type;code;constructor(e,t,r){super(e??"The operation was aborted"),this.type="aborted",this.name=r??"AbortError",this.code=t??"ABORT_ERR"}};async function Cr(n,e,t){if(e==null)return n;if(e.aborted)return Promise.reject(new Je(t?.errorMessage,t?.errorCode,t?.errorName));let r,s=new Je(t?.errorMessage,t?.errorCode,t?.errorName);try{return await Promise.race([n,new Promise((i,a)=>{r=()=>{a(s)},e.addEventListener("abort",r)})])}finally{r!=null&&e.removeEventListener("abort",r)}}var Ke=class{deferred;signal;constructor(e){this.signal=e,this.deferred=F(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new W)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function Fn(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var Ze=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=Fn(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,U(1/0,this.controller.signal),this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,r)=>t&&r.signal?.aborted===!0,!0)&&(this.controller.abort(new W),this.cleanup())}async join(e={}){let t=new Ke(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await Cr(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};var de=class extends q{concurrency;maxSize;queue;pending;sort;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[]}tryToStartAnother(){if(this.size===0)return queueMicrotask(()=>{this.safeDispatchEvent("empty")}),this.running===0&&queueMicrotask(()=>{this.safeDispatchEvent("idle")}),!1;if(this.pending<this.concurrency){let e;for(let t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new Qe;let r=new Ze(e,t);return this.enqueue(r),this.safeDispatchEvent("add"),this.tryToStartAnother(),r.join(t).then(s=>(this.safeDispatchEvent("completed",{detail:s}),this.safeDispatchEvent("success",{detail:{job:r,result:s}}),s)).catch(s=>{if(r.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===r){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("error",{detail:s}),this.safeDispatchEvent("failure",{detail:{job:r,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new W)}),this.clear()}async onEmpty(e){this.size!==0&&await O(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await O(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await O(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();let t=fe({objectMode:!0}),r=u=>{u!=null?this.abort():this.clear(),t.end(u)},s=u=>{u.detail!=null&&t.push(u.detail)},i=u=>{r(u.detail)},a=()=>{r()},c=()=>{r(new W("Queue aborted"))};this.addEventListener("completed",s),this.addEventListener("error",i),this.addEventListener("idle",a),e?.signal?.addEventListener("abort",c);try{yield*t}finally{this.removeEventListener("completed",s),this.removeEventListener("error",i),this.removeEventListener("idle",a),e?.signal?.removeEventListener("abort",c),r()}}};var Ye=class extends de{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}};function On(n){return n[Symbol.asyncIterator]!=null}function zn(n){if(On(n))return(async()=>{for await(let e of n);})();for(let e of n);}var Bt=zn;function M(n=0){return new Uint8Array(n)}function I(n=0){return new Uint8Array(n)}var Hn=Math.pow(2,7),qn=Math.pow(2,14),Vn=Math.pow(2,21),Nt=Math.pow(2,28),Ct=Math.pow(2,35),Ut=Math.pow(2,42),Pt=Math.pow(2,49),L=128,B=127;function _(n){if(n<Hn)return 1;if(n<qn)return 2;if(n<Vn)return 3;if(n<Nt)return 4;if(n<Ct)return 5;if(n<Ut)return 6;if(n<Pt)return 7;if(Number.MAX_SAFE_INTEGER!=null&&n>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Rt(n,e,t=0){switch(_(n)){case 8:e[t++]=n&255|L,n/=128;case 7:e[t++]=n&255|L,n/=128;case 6:e[t++]=n&255|L,n/=128;case 5:e[t++]=n&255|L,n/=128;case 4:e[t++]=n&255|L,n>>>=7;case 3:e[t++]=n&255|L,n>>>=7;case 2:e[t++]=n&255|L,n>>>=7;case 1:{e[t++]=n&255,n>>>=7;break}default:throw new Error("unreachable")}return e}function Gn(n,e,t=0){switch(_(n)){case 8:e.set(t++,n&255|L),n/=128;case 7:e.set(t++,n&255|L),n/=128;case 6:e.set(t++,n&255|L),n/=128;case 5:e.set(t++,n&255|L),n/=128;case 4:e.set(t++,n&255|L),n>>>=7;case 3:e.set(t++,n&255|L),n>>>=7;case 2:e.set(t++,n&255|L),n>>>=7;case 1:{e.set(t++,n&255),n>>>=7;break}default:throw new Error("unreachable")}return e}function Ft(n,e){let t=n[e],r=0;if(r+=t&B,t<L||(t=n[e+1],r+=(t&B)<<7,t<L)||(t=n[e+2],r+=(t&B)<<14,t<L)||(t=n[e+3],r+=(t&B)<<21,t<L)||(t=n[e+4],r+=(t&B)*Nt,t<L)||(t=n[e+5],r+=(t&B)*Ct,t<L)||(t=n[e+6],r+=(t&B)*Ut,t<L)||(t=n[e+7],r+=(t&B)*Pt,t<L))return r;throw new RangeError("Could not decode varint")}function Wn(n,e){let t=n.get(e),r=0;if(r+=t&B,t<L||(t=n.get(e+1),r+=(t&B)<<7,t<L)||(t=n.get(e+2),r+=(t&B)<<14,t<L)||(t=n.get(e+3),r+=(t&B)<<21,t<L)||(t=n.get(e+4),r+=(t&B)*Nt,t<L)||(t=n.get(e+5),r+=(t&B)*Ct,t<L)||(t=n.get(e+6),r+=(t&B)*Ut,t<L)||(t=n.get(e+7),r+=(t&B)*Pt,t<L))return r;throw new RangeError("Could not decode varint")}function je(n,e,t=0){return e==null&&(e=I(_(n))),e instanceof Uint8Array?Rt(n,e,t):Gn(n,e,t)}function et(n,e=0){return n instanceof Uint8Array?Ft(n,e):Wn(n,e)}function Ot(n,e){e==null&&(e=n.reduce((s,i)=>s+i.length,0));let t=I(e),r=0;for(let s of n)t.set(s,r),r+=s.length;return t}function j(n,e){if(n===e)return!0;if(n.byteLength!==e.byteLength)return!1;for(let t=0;t<n.byteLength;t++)if(n[t]!==e[t])return!1;return!0}var Rr=Symbol.for("@achingbrain/uint8arraylist");function Pr(n,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(let r of n){let s=t+r.byteLength;if(e<s)return{buf:r,index:e-t};t=s}throw new RangeError("index is out of bounds")}function tt(n){return!!n?.[Rr]}var K=class n{bufs;length;[Rr]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let r of e)if(r instanceof Uint8Array)t+=r.byteLength,this.bufs.push(r);else if(tt(r))t+=r.byteLength,this.bufs.push(...r.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let r of e.reverse())if(r instanceof Uint8Array)t+=r.byteLength,this.bufs.unshift(r);else if(tt(r))t+=r.byteLength,this.bufs.unshift(...r.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){let t=Pr(this.bufs,e);return t.buf[t.index]}set(e,t){let r=Pr(this.bufs,e);r.buf[r.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let r=0;r<e.length;r++)this.set(t+r,e[r]);else if(tt(e))for(let r=0;r<e.length;r++)this.set(t+r,e.get(r));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){let{bufs:r,length:s}=this._subList(e,t);return Ot(r,s)}subarray(e,t){let{bufs:r,length:s}=this._subList(e,t);return r.length===1?r[0]:Ot(r,s)}sublist(e,t){let{bufs:r,length:s}=this._subList(e,t),i=new n;return i.length=s,i.bufs=[...r],i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};let r=[],s=0;for(let i=0;i<this.bufs.length;i++){let a=this.bufs[i],c=s,u=c+a.byteLength;if(s=u,e>=u)continue;let p=e>=c&&e<u,x=t>c&&t<=u;if(p&&x){if(e===c&&t===u){r.push(a);break}let m=e-c;r.push(a.subarray(m,m+(t-e)));break}if(p){if(e===0){r.push(a);continue}r.push(a.subarray(e-c));continue}if(x){if(t===u){r.push(a);break}r.push(a.subarray(0,t-c));break}r.push(a)}return{bufs:r,length:t-e}}indexOf(e,t=0){if(!tt(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let r=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;let s=r.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");let i=256,a=new Int32Array(i);for(let m=0;m<i;m++)a[m]=-1;for(let m=0;m<s;m++)a[r[m]]=m;let c=a,u=this.byteLength-r.byteLength,p=r.byteLength-1,x;for(let m=t;m<=u;m+=x){x=0;for(let A=p;A>=0;A--){let o=this.get(m+A);if(r[A]!==o){x=Math.max(1,A-c[o]);break}}if(x===0)return m}return-1}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let r=I(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt8(0,t),this.write(r,e)}getInt16(e,t){let r=this.subarray(e,e+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt16(0,t)}setInt16(e,t,r){let s=M(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,r),this.write(s,e)}getInt32(e,t){let r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt32(0,t)}setInt32(e,t,r){let s=M(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,r),this.write(s,e)}getBigInt64(e,t){let r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigInt64(0,t)}setBigInt64(e,t,r){let s=M(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,r),this.write(s,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let r=I(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setUint8(0,t),this.write(r,e)}getUint16(e,t){let r=this.subarray(e,e+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,t)}setUint16(e,t,r){let s=M(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,r),this.write(s,e)}getUint32(e,t){let r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint32(0,t)}setUint32(e,t,r){let s=M(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,r),this.write(s,e)}getBigUint64(e,t){let r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigUint64(0,t)}setBigUint64(e,t,r){let s=M(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,r),this.write(s,e)}getFloat32(e,t){let r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat32(0,t)}setFloat32(e,t,r){let s=M(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,r),this.write(s,e)}getFloat64(e,t){let r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat64(0,t)}setFloat64(e,t,r){let s=M(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,r),this.write(s,e)}equals(e){if(e==null||!(e instanceof n)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!j(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){let r=new n;return r.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),r.length=t,r}};function rt(n){return n[Symbol.asyncIterator]!=null}var nt=n=>{let e=_(n),t=I(e);return je(n,t),nt.bytes=e,t};nt.bytes=0;function st(n,e){e=e??{};let t=e.lengthEncoder??nt;function*r(s){let i=t(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}return rt(n)?async function*(){for await(let s of n)yield*r(s)}():function*(){for(let s of n)yield*r(s)}()}st.single=(n,e)=>{e=e??{};let t=e.lengthEncoder??nt;return new K(t(n.byteLength),n)};var it=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},ot=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},at=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},Ae=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};var $n=8,Xn=1024*1024*4,ee;(function(n){n[n.LENGTH=0]="LENGTH",n[n.DATA=1]="DATA"})(ee||(ee={}));var zt=n=>{let e=et(n);return zt.bytes=_(e),e};zt.bytes=0;function De(n,e){let t=new K,r=ee.LENGTH,s=-1,i=e?.lengthDecoder??zt,a=e?.maxLengthLength??$n,c=e?.maxDataLength??Xn;function*u(){for(;t.byteLength>0;){if(r===ee.LENGTH)try{if(s=i(t),s<0)throw new it("Invalid message length");if(s>c)throw new ot("Message length too long");let p=i.bytes;t.consume(p),e?.onLength!=null&&e.onLength(s),r=ee.DATA}catch(p){if(p instanceof RangeError){if(t.byteLength>a)throw new at("Message length length too long");break}throw p}if(r===ee.DATA){if(t.byteLength<s)break;let p=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(p),yield p,r=ee.LENGTH}}}return rt(n)?async function*(){for await(let p of n)t.append(p),yield*u();if(t.byteLength>0)throw new Ae("Unexpected end of input")}():function*(){for(let p of n)t.append(p),yield*u();if(t.byteLength>0)throw new Ae("Unexpected end of input")}()}De.fromReader=(n,e)=>{let t=1,r=async function*(){for(;;)try{let{done:i,value:a}=await n.next(t);if(i===!0)return;a!=null&&(yield a)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return De(r,{...e??{},onLength:i=>{t=i}})};function Jn(n){let[e,t]=n[Symbol.asyncIterator]!=null?[n[Symbol.asyncIterator](),Symbol.asyncIterator]:[n[Symbol.iterator](),Symbol.iterator],r=[];return{peek:()=>e.next(),push:s=>{r.push(s)},next:()=>r.length>0?{done:!1,value:r.shift()}:e.next(),[t](){return this}}}var Fr=Jn;function Kn(n){return n[Symbol.asyncIterator]!=null}function Zn(n,e){let t=0;if(Kn(n))return async function*(){for await(let u of n)yield e(u,t++)}();let r=Fr(n),{value:s,done:i}=r.next();if(i===!0)return function*(){}();let a=e(s,t++);if(typeof a.then=="function")return async function*(){yield await a;for await(let u of r)yield e(u,t++)}();let c=e;return function*(){yield a;for(let u of r)yield c(u,t++)}()}var Or=Zn;function Yn(n){return n[Symbol.asyncIterator]!=null}function jn(...n){let e=[];for(let t of n)Yn(t)||e.push(t);return e.length===n.length?function*(){for(let t of e)yield*t}():async function*(){let t=fe({objectMode:!0});Promise.resolve().then(async()=>{try{await Promise.all(n.map(async r=>{for await(let s of r)t.push(s)})),t.end()}catch(r){t.end(r)}}),yield*t}()}var zr=jn;function qt(n,...e){if(n==null)throw new Error("Empty pipeline");if(Ht(n)){let r=n;n=()=>r.source}else if(qr(n)||Hr(n)){let r=n;n=()=>r}let t=[n,...e];if(t.length>1&&Ht(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let r=1;r<t.length-1;r++)Ht(t[r])&&(t[r]=ts(t[r]));return es(...t)}var es=(...n)=>{let e;for(;n.length>0;)e=n.shift()(e);return e},Hr=n=>n?.[Symbol.asyncIterator]!=null,qr=n=>n?.[Symbol.iterator]!=null,Ht=n=>n==null?!1:n.sink!=null&&n.source!=null,ts=n=>e=>{let t=n.sink(e);if(t?.then!=null){let r=fe({objectMode:!0});t.then(()=>{r.end()},a=>{r.end(a)});let s,i=n.source;if(Hr(i))s=async function*(){yield*i,r.end()};else if(qr(i))s=function*(){yield*i,r.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return zr(r,s())}return n.source};function rs(n){return n[Symbol.asyncIterator]!=null}function ns(n,e){return rs(n)?async function*(){let t=0;if(!(e<1)){for await(let r of n)if(yield r,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(let r of n)if(yield r,t++,t===e)return}}()}var Vr=ns;var V=class extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}};var Te="/ipfs/bitswap/1.2.0";var Vt=new Float32Array([-0]),Z=new Uint8Array(Vt.buffer);function Gr(n,e,t){Vt[0]=n,e[t]=Z[0],e[t+1]=Z[1],e[t+2]=Z[2],e[t+3]=Z[3]}function Wr(n,e){return Z[0]=n[e],Z[1]=n[e+1],Z[2]=n[e+2],Z[3]=n[e+3],Vt[0]}var Gt=new Float64Array([-0]),N=new Uint8Array(Gt.buffer);function $r(n,e,t){Gt[0]=n,e[t]=N[0],e[t+1]=N[1],e[t+2]=N[2],e[t+3]=N[3],e[t+4]=N[4],e[t+5]=N[5],e[t+6]=N[6],e[t+7]=N[7]}function Xr(n,e){return N[0]=n[e],N[1]=n[e+1],N[2]=n[e+2],N[3]=n[e+3],N[4]=n[e+4],N[5]=n[e+5],N[6]=n[e+6],N[7]=n[e+7],Gt[0]}var ss=BigInt(Number.MAX_SAFE_INTEGER),is=BigInt(Number.MIN_SAFE_INTEGER),P=class n{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){let t=~this.lo+1>>>0,r=~this.hi>>>0;return t===0&&(r=r+1>>>0),-(t+r*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let t=~this.lo+1>>>0,r=~this.hi>>>0;return t===0&&(r=r+1>>>0),-(BigInt(t)+(BigInt(r)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){let e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){let e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){let e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,r=this.hi>>>24;return r===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:r<128?9:10}static fromBigInt(e){if(e===0n)return te;if(e<ss&&e>is)return this.fromNumber(Number(e));let t=e<0n;t&&(e=-e);let r=e>>32n,s=e-(r<<32n);return t&&(r=~r|0n,s=~s|0n,++s>Qr&&(s=0n,++r>Qr&&(r=0n))),new n(Number(s),Number(r))}static fromNumber(e){if(e===0)return te;let t=e<0;t&&(e=-e);let r=e>>>0,s=(e-r)/4294967296>>>0;return t&&(s=~s>>>0,r=~r>>>0,++r>4294967295&&(r=0,++s>4294967295&&(s=0))),new n(r,s)}static from(e){return typeof e=="number"?n.fromNumber(e):typeof e=="bigint"?n.fromBigInt(e):typeof e=="string"?n.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new n(e.low>>>0,e.high>>>0):te}},te=new P(0,0);te.toBigInt=function(){return 0n};te.zzEncode=te.zzDecode=function(){return this};te.length=function(){return 1};var Qr=4294967296n;function Jr(n){let e=0,t=0;for(let r=0;r<n.length;++r)t=n.charCodeAt(r),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(n.charCodeAt(r+1)&64512)===56320?(++r,e+=4):e+=3;return e}function Kr(n,e,t){if(t-e<1)return"";let s,i=[],a=0,c;for(;e<t;)c=n[e++],c<128?i[a++]=c:c>191&&c<224?i[a++]=(c&31)<<6|n[e++]&63:c>239&&c<365?(c=((c&7)<<18|(n[e++]&63)<<12|(n[e++]&63)<<6|n[e++]&63)-65536,i[a++]=55296+(c>>10),i[a++]=56320+(c&1023)):i[a++]=(c&15)<<12|(n[e++]&63)<<6|n[e++]&63,a>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,i)),a=0);return s!=null?(a>0&&s.push(String.fromCharCode.apply(String,i.slice(0,a))),s.join("")):String.fromCharCode.apply(String,i.slice(0,a))}function Wt(n,e,t){let r=t,s,i;for(let a=0;a<n.length;++a)s=n.charCodeAt(a),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((i=n.charCodeAt(a+1))&64512)===56320?(s=65536+((s&1023)<<10)+(i&1023),++a,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-r}function z(n,e){return RangeError(`index out of range: ${n.pos} + ${e??1} > ${n.len}`)}function ct(n,e){return(n[e-4]|n[e-3]<<8|n[e-2]<<16|n[e-1]<<24)>>>0}var $t=class{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,z(this,10);return e}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw z(this,4);return ct(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw z(this,4);return ct(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw z(this,4);let e=Wr(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw z(this,4);let e=Xr(this.buf,this.pos);return this.pos+=8,e}bytes(){let e=this.uint32(),t=this.pos,r=this.pos+e;if(r>this.len)throw z(this,e);return this.pos+=e,t===r?new Uint8Array(0):this.buf.subarray(t,r)}string(){let e=this.bytes();return Kr(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw z(this,e);this.pos+=e}else do if(this.pos>=this.len)throw z(this);while(this.buf[this.pos++]&128);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){let e=new P(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw z(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw z(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw z(this,8);let e=ct(this.buf,this.pos+=4),t=ct(this.buf,this.pos+=4);return new P(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let e=Ft(this.buf,this.pos);return this.pos+=_(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function Xt(n){return new $t(n instanceof Uint8Array?n:n.subarray())}function re(n,e,t){let r=Xt(n);return e.decode(r,void 0,t)}var Yt={};C(Yt,{base10:()=>hs});var ca=new Uint8Array(0);function Yr(n,e){if(n===e)return!0;if(n.byteLength!==e.byteLength)return!1;for(let t=0;t<n.byteLength;t++)if(n[t]!==e[t])return!1;return!0}function $(n){if(n instanceof Uint8Array&&n.constructor.name==="Uint8Array")return n;if(n instanceof ArrayBuffer)return new Uint8Array(n);if(ArrayBuffer.isView(n))return new Uint8Array(n.buffer,n.byteOffset,n.byteLength);throw new Error("Unknown type, must be binary type")}function jr(n){return new TextEncoder().encode(n)}function en(n){return new TextDecoder().decode(n)}function os(n,e){if(n.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;for(var s=0;s<n.length;s++){var i=n.charAt(s),a=i.charCodeAt(0);if(t[a]!==255)throw new TypeError(i+" is ambiguous");t[a]=s}var c=n.length,u=n.charAt(0),p=Math.log(c)/Math.log(256),x=Math.log(256)/Math.log(c);function m(l){if(l instanceof Uint8Array||(ArrayBuffer.isView(l)?l=new Uint8Array(l.buffer,l.byteOffset,l.byteLength):Array.isArray(l)&&(l=Uint8Array.from(l))),!(l instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(l.length===0)return"";for(var h=0,E=0,f=0,d=l.length;f!==d&&l[f]===0;)f++,h++;for(var g=(d-f)*x+1>>>0,b=new Uint8Array(g);f!==d;){for(var y=l[f],v=0,w=g-1;(y!==0||v<E)&&w!==-1;w--,v++)y+=256*b[w]>>>0,b[w]=y%c>>>0,y=y/c>>>0;if(y!==0)throw new Error("Non-zero carry");E=v,f++}for(var S=g-E;S!==g&&b[S]===0;)S++;for(var G=u.repeat(h);S<g;++S)G+=n.charAt(b[S]);return G}function A(l){if(typeof l!="string")throw new TypeError("Expected String");if(l.length===0)return new Uint8Array;var h=0;if(l[h]!==" "){for(var E=0,f=0;l[h]===u;)E++,h++;for(var d=(l.length-h)*p+1>>>0,g=new Uint8Array(d);l[h];){var b=t[l.charCodeAt(h)];if(b===255)return;for(var y=0,v=d-1;(b!==0||y<f)&&v!==-1;v--,y++)b+=c*g[v]>>>0,g[v]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");f=y,h++}if(l[h]!==" "){for(var w=d-f;w!==d&&g[w]===0;)w++;for(var S=new Uint8Array(E+(d-w)),G=E;w!==d;)S[G++]=g[w++];return S}}}function o(l){var h=A(l);if(h)return h;throw new Error(`Non-${e} character`)}return{encode:m,decodeUnsafe:A,decode:o}}var as=os,cs=as,rn=cs;var Qt=class{name;prefix;baseEncode;constructor(e,t,r){this.name=e,this.prefix=t,this.baseEncode=r}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Jt=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,r){this.name=e,this.prefix=t;let s=t.codePointAt(0);if(s===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s,this.baseDecode=r}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return nn(this,e)}},Kt=class{decoders;constructor(e){this.decoders=e}or(e){return nn(this,e)}decode(e){let t=e[0],r=this.decoders[t];if(r!=null)return r.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function nn(n,e){return new Kt({...n.decoders??{[n.prefix]:n},...e.decoders??{[e.prefix]:e}})}var Zt=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,r,s){this.name=e,this.prefix=t,this.baseEncode=r,this.baseDecode=s,this.encoder=new Qt(e,t,r),this.decoder=new Jt(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function pe({name:n,prefix:e,encode:t,decode:r}){return new Zt(n,e,t,r)}function Y({name:n,prefix:e,alphabet:t}){let{encode:r,decode:s}=rn(t,n);return pe({prefix:e,name:n,encode:r,decode:i=>$(s(i))})}function ls(n,e,t,r){let s={};for(let x=0;x<e.length;++x)s[e[x]]=x;let i=n.length;for(;n[i-1]==="=";)--i;let a=new Uint8Array(i*t/8|0),c=0,u=0,p=0;for(let x=0;x<i;++x){let m=s[n[x]];if(m===void 0)throw new SyntaxError(`Non-${r} character`);u=u<<t|m,c+=t,c>=8&&(c-=8,a[p++]=255&u>>c)}if(c>=t||255&u<<8-c)throw new SyntaxError("Unexpected end of data");return a}function us(n,e,t){let r=e[e.length-1]==="=",s=(1<<t)-1,i="",a=0,c=0;for(let u=0;u<n.length;++u)for(c=c<<8|n[u],a+=8;a>t;)a-=t,i+=e[s&c>>a];if(a!==0&&(i+=e[s&c<<t-a]),r)for(;i.length*t&7;)i+="=";return i}function D({name:n,prefix:e,bitsPerChar:t,alphabet:r}){return pe({prefix:e,name:n,encode(s){return us(s,r,t)},decode(s){return ls(s,r,t,n)}})}var hs=Y({prefix:"9",name:"base10",alphabet:"0123456789"});var jt={};C(jt,{base16:()=>fs,base16upper:()=>ds});var fs=D({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),ds=D({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var er={};C(er,{base2:()=>ps});var ps=D({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var tr={};C(tr,{base256emoji:()=>xs});var sn=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),ms=sn.reduce((n,e,t)=>(n[t]=e,n),[]),gs=sn.reduce((n,e,t)=>{let r=e.codePointAt(0);if(r==null)throw new Error(`Invalid character: ${e}`);return n[r]=t,n},[]);function ws(n){return n.reduce((e,t)=>(e+=ms[t],e),"")}function bs(n){let e=[];for(let t of n){let r=t.codePointAt(0);if(r==null)throw new Error(`Invalid character: ${t}`);let s=gs[r];if(s==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}var xs=pe({prefix:"\u{1F680}",name:"base256emoji",encode:ws,decode:bs});var rr={};C(rr,{base32:()=>me,base32hex:()=>ks,base32hexpad:()=>Ss,base32hexpadupper:()=>As,base32hexupper:()=>Ls,base32pad:()=>Es,base32padupper:()=>vs,base32upper:()=>ys,base32z:()=>Ds});var me=D({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),ys=D({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Es=D({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),vs=D({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),ks=D({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Ls=D({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Ss=D({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),As=D({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Ds=D({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var nr={};C(nr,{base36:()=>_e,base36upper:()=>Ts});var _e=Y({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Ts=Y({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var sr={};C(sr,{base58btc:()=>H,base58flickr:()=>_s});var H=Y({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),_s=Y({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var ir={};C(ir,{base64:()=>ne,base64pad:()=>Ms,base64url:()=>Is,base64urlpad:()=>Bs});var ne=D({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Ms=D({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Is=D({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Bs=D({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var or={};C(or,{base8:()=>Ns});var Ns=D({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var ar={};C(ar,{identity:()=>Cs});var Cs=pe({prefix:"\0",name:"identity",encode:n=>en(n),decode:n=>jr(n)});var La=new TextEncoder,Sa=new TextDecoder;var ur={};C(ur,{identity:()=>ni});var Rs=cn,on=128,Fs=127,Os=~Fs,zs=Math.pow(2,31);function cn(n,e,t){e=e||[],t=t||0;for(var r=t;n>=zs;)e[t++]=n&255|on,n/=128;for(;n&Os;)e[t++]=n&255|on,n>>>=7;return e[t]=n|0,cn.bytes=t-r+1,e}var Hs=cr,qs=128,an=127;function cr(n,r){var t=0,r=r||0,s=0,i=r,a,c=n.length;do{if(i>=c)throw cr.bytes=0,new RangeError("Could not decode varint");a=n[i++],t+=s<28?(a&an)<<s:(a&an)*Math.pow(2,s),s+=7}while(a>=qs);return cr.bytes=i-r,t}var Vs=Math.pow(2,7),Gs=Math.pow(2,14),Ws=Math.pow(2,21),$s=Math.pow(2,28),Xs=Math.pow(2,35),Qs=Math.pow(2,42),Js=Math.pow(2,49),Ks=Math.pow(2,56),Zs=Math.pow(2,63),Ys=function(n){return n<Vs?1:n<Gs?2:n<Ws?3:n<$s?4:n<Xs?5:n<Qs?6:n<Js?7:n<Ks?8:n<Zs?9:10},js={encode:Rs,decode:Hs,encodingLength:Ys},ei=js,Me=ei;function Ie(n,e=0){return[Me.decode(n,e),Me.decode.bytes]}function ge(n,e,t=0){return Me.encode(n,e,t),e}function we(n){return Me.encodingLength(n)}function se(n,e){let t=e.byteLength,r=we(n),s=r+we(t),i=new Uint8Array(s+t);return ge(n,i,0),ge(t,i,r),i.set(e,s),new be(n,t,e,i)}function lr(n){let e=$(n),[t,r]=Ie(e),[s,i]=Ie(e.subarray(r)),a=e.subarray(r+i);if(a.byteLength!==s)throw new Error("Incorrect length");return new be(t,s,a,e)}function ln(n,e){if(n===e)return!0;{let t=e;return n.code===t.code&&n.size===t.size&&t.bytes instanceof Uint8Array&&Yr(n.bytes,t.bytes)}}var be=class{code;size;digest;bytes;constructor(e,t,r,s){this.code=e,this.size=t,this.digest=r,this.bytes=s}};var un=0,ti="identity",hn=$;function ri(n){return se(un,hn(n))}var ni={code:un,name:ti,encode:hn,digest:ri};var dr={};C(dr,{sha256:()=>ut,sha512:()=>si});function fr({name:n,code:e,encode:t}){return new hr(n,e,t)}var hr=class{name;code;encode;constructor(e,t,r){this.name=e,this.code=t,this.encode=r}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?se(this.code,t):t.then(r=>se(this.code,r))}else throw Error("Unknown type, must be binary type")}};function dn(n){return async e=>new Uint8Array(await crypto.subtle.digest(n,e))}var ut=fr({name:"sha2-256",code:18,encode:dn("SHA-256")}),si=fr({name:"sha2-512",code:19,encode:dn("SHA-512")});function pn(n,e){let{bytes:t,version:r}=n;switch(r){case 0:return oi(t,pr(n),e??H.encoder);default:return ai(t,pr(n),e??me.encoder)}}var mn=new WeakMap;function pr(n){let e=mn.get(n);if(e==null){let t=new Map;return mn.set(n,t),t}return e}var X=class n{code;version;multihash;bytes;"/";constructor(e,t,r,s){this.code=t,this.version=e,this.multihash=r,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==Be)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==ci)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return n.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,r=se(e,t);return n.createV1(this.code,r)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return n.equals(this,e)}static equals(e,t){let r=t;return r!=null&&e.code===r.code&&e.version===r.version&&ln(e.multihash,r.multihash)}toString(e){return pn(this,e)}toJSON(){return{"/":pn(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof n)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:r,code:s,multihash:i,bytes:a}=t;return new n(r,s,i,a??gn(r,s,i.bytes))}else if(t[li]===!0){let{version:r,multihash:s,code:i}=t,a=lr(s);return n.create(r,i,a)}else return null}static create(e,t,r){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(r.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Be)throw new Error(`Version 0 CID must use dag-pb (code: ${Be}) block encoding`);return new n(e,t,r,r.bytes)}case 1:{let s=gn(e,t,r.bytes);return new n(e,t,r,s)}default:throw new Error("Invalid version")}}static createV0(e){return n.create(0,Be,e)}static createV1(e,t){return n.create(1,e,t)}static decode(e){let[t,r]=n.decodeFirst(e);if(r.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=n.inspectBytes(e),r=t.size-t.multihashSize,s=$(e.subarray(r,r+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");let i=s.subarray(t.multihashSize-t.digestSize),a=new be(t.multihashCode,t.digestSize,i,s);return[t.version===0?n.createV0(a):n.createV1(t.codec,a),e.subarray(t.size)]}static inspectBytes(e){let t=0,r=()=>{let[m,A]=Ie(e.subarray(t));return t+=A,m},s=r(),i=Be;if(s===18?(s=0,t=0):i=r(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);let a=t,c=r(),u=r(),p=t+u,x=p-a;return{version:s,codec:i,multihashCode:c,digestSize:u,multihashSize:x,size:p}}static parse(e,t){let[r,s]=ii(e,t),i=n.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return pr(i).set(r,e),i}};function ii(n,e){switch(n[0]){case"Q":{let t=e??H;return[H.prefix,t.decode(`${H.prefix}${n}`)]}case H.prefix:{let t=e??H;return[H.prefix,t.decode(n)]}case me.prefix:{let t=e??me;return[me.prefix,t.decode(n)]}case _e.prefix:{let t=e??_e;return[_e.prefix,t.decode(n)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[n[0],e.decode(n)]}}}function oi(n,e,t){let{prefix:r}=t;if(r!==H.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let s=e.get(r);if(s==null){let i=t.encode(n).slice(1);return e.set(r,i),i}else return s}function ai(n,e,t){let{prefix:r}=t,s=e.get(r);if(s==null){let i=t.encode(n);return e.set(r,i),i}else return s}var Be=112,ci=18;function gn(n,e,t){let r=we(n),s=r+we(e),i=new Uint8Array(s+t.byteLength);return ge(n,i,0),ge(e,i,r),i.set(t,s),i}var li=Symbol.for("@ipld/js-cid/CID");var mr={...ar,...er,...or,...Yt,...jt,...rr,...nr,...sr,...ir,...tr},Xa={...dr,...ur};function bn(n,e,t,r){return{name:n,prefix:e,encoder:{name:n,prefix:e,encode:t},decoder:{decode:r}}}var wn=bn("utf8","u",n=>"u"+new TextDecoder("utf8").decode(n),n=>new TextEncoder().encode(n.substring(1))),gr=bn("ascii","a",n=>{let e="a";for(let t=0;t<n.length;t++)e+=String.fromCharCode(n[t]);return e},n=>{n=n.substring(1);let e=I(n.length);for(let t=0;t<n.length;t++)e[t]=n.charCodeAt(t);return e}),ui={utf8:wn,"utf-8":wn,hex:mr.base16,latin1:gr,ascii:gr,binary:gr,...mr},ht=ui;function Ne(n,e="utf8"){let t=ht[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${n}`)}function wr(n){let e=n??8192,t=e>>>1,r,s=e;return function(a){if(a<1||a>t)return I(a);s+a>e&&(r=I(e),s=0);let c=r.subarray(s,s+=a);return s&7&&(s=(s|7)+1),c}}var ie=class{fn;len;next;val;constructor(e,t,r){this.fn=e,this.len=t,this.next=void 0,this.val=r}};function br(){}var yr=class{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}},hi=wr();function fi(n){return globalThis.Buffer!=null?I(n):hi(n)}var Ue=class{len;head;tail;states;constructor(){this.len=0,this.head=new ie(br,0,0),this.tail=this.head,this.states=null}_push(e,t,r){return this.tail=this.tail.next=new ie(e,t,r),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new Er((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(ft,10,P.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){let t=P.fromBigInt(e);return this._push(ft,t.length(),t)}uint64Number(e){return this._push(Rt,_(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){let t=P.fromBigInt(e).zzEncode();return this._push(ft,t.length(),t)}sint64Number(e){let t=P.fromNumber(e).zzEncode();return this._push(ft,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(xr,1,e?1:0)}fixed32(e){return this._push(Ce,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){let t=P.fromBigInt(e);return this._push(Ce,4,t.lo)._push(Ce,4,t.hi)}fixed64Number(e){let t=P.fromNumber(e);return this._push(Ce,4,t.lo)._push(Ce,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(Gr,4,e)}double(e){return this._push($r,8,e)}bytes(e){let t=e.length>>>0;return t===0?this._push(xr,1,0):this.uint32(t)._push(pi,t,e)}string(e){let t=Jr(e);return t!==0?this.uint32(t)._push(Wt,t,e):this._push(xr,1,0)}fork(){return this.states=new yr(this),this.head=this.tail=new ie(br,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new ie(br,0,0),this.len=0),this}ldelim(){let e=this.head,t=this.tail,r=this.len;return this.reset().uint32(r),r!==0&&(this.tail.next=e.next,this.tail=t,this.len+=r),this}finish(){let e=this.head.next,t=fi(this.len),r=0;for(;e!=null;)e.fn(e.val,t,r),r+=e.len,e=e.next;return t}};function xr(n,e,t){e[t]=n&255}function di(n,e,t){for(;n>127;)e[t++]=n&127|128,n>>>=7;e[t]=n}var Er=class extends ie{next;constructor(e,t){super(di,e,t),this.next=void 0}};function ft(n,e,t){for(;n.hi!==0;)e[t++]=n.lo&127|128,n.lo=(n.lo>>>7|n.hi<<25)>>>0,n.hi>>>=7;for(;n.lo>127;)e[t++]=n.lo&127|128,n.lo=n.lo>>>7;e[t++]=n.lo}function Ce(n,e,t){e[t]=n&255,e[t+1]=n>>>8&255,e[t+2]=n>>>16&255,e[t+3]=n>>>24}function pi(n,e,t){e.set(n,t)}globalThis.Buffer!=null&&(Ue.prototype.bytes=function(n){let e=n.length>>>0;return this.uint32(e),e>0&&this._push(mi,e,n),this},Ue.prototype.string=function(n){let e=globalThis.Buffer.byteLength(n);return this.uint32(e),e>0&&this._push(gi,e,n),this});function mi(n,e,t){e.set(n,t)}function gi(n,e,t){n.length<40?Wt(n,e,t):e.utf8Write!=null?e.utf8Write(n,t):e.set(Ne(n),t)}function vr(){return new Ue}function oe(n,e){let t=vr();return e.encode(n,t,{lengthDelimited:!1}),t.finish()}var ye;(function(n){n[n.VARINT=0]="VARINT",n[n.BIT64=1]="BIT64",n[n.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",n[n.START_GROUP=3]="START_GROUP",n[n.END_GROUP=4]="END_GROUP",n[n.BIT32=5]="BIT32"})(ye||(ye={}));function dt(n,e,t,r){return{name:n,type:e,encode:t,decode:r}}function pt(n){function e(s){if(n[s.toString()]==null)throw new Error("Invalid enum value");return n[s]}let t=function(i,a){let c=e(i);a.int32(c)},r=function(i){let a=i.int32();return e(a)};return dt("enum",ye.VARINT,t,r)}function ae(n,e){return dt("message",ye.LENGTH_DELIMITED,n,e)}var Ee=class extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"};var T;(function(n){n.WantBlock="WantBlock",n.WantHave="WantHave"})(T||(T={}));var kr;(function(n){n[n.WantBlock=0]="WantBlock",n[n.WantHave=1]="WantHave"})(kr||(kr={}));(function(n){n.codec=()=>pt(kr)})(T||(T={}));var ve;(function(n){let e;n.codec=()=>(e==null&&(e=ae((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.cid!=null&&t.cid.byteLength>0&&(r.uint32(10),r.bytes(t.cid)),t.priority!=null&&t.priority!==0&&(r.uint32(16),r.int32(t.priority)),t.cancel!=null&&(r.uint32(24),r.bool(t.cancel)),t.wantType!=null&&(r.uint32(32),T.codec().encode(t.wantType,r)),t.sendDontHave!=null&&(r.uint32(40),r.bool(t.sendDontHave)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{let i={cid:M(0),priority:0},a=r==null?t.len:t.pos+r;for(;t.pos<a;){let c=t.uint32();switch(c>>>3){case 1:{i.cid=t.bytes();break}case 2:{i.priority=t.int32();break}case 3:{i.cancel=t.bool();break}case 4:{i.wantType=T.codec().decode(t);break}case 5:{i.sendDontHave=t.bool();break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>oe(t,n.codec()),n.decode=(t,r)=>re(t,n.codec(),r)})(ve||(ve={}));var mt;(function(n){let e;n.codec=()=>(e==null&&(e=ae((t,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),t.entries!=null)for(let i of t.entries)r.uint32(10),ve.codec().encode(i,r);t.full!=null&&(r.uint32(16),r.bool(t.full)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{let i={entries:[]},a=r==null?t.len:t.pos+r;for(;t.pos<a;){let c=t.uint32();switch(c>>>3){case 1:{if(s.limits?.entries!=null&&i.entries.length===s.limits.entries)throw new Ee('Decode error - map field "entries" had too many elements');i.entries.push(ve.codec().decode(t,t.uint32(),{limits:s.limits?.entries$}));break}case 2:{i.full=t.bool();break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>oe(t,n.codec()),n.decode=(t,r)=>re(t,n.codec(),r)})(mt||(mt={}));var ke;(function(n){let e;n.codec=()=>(e==null&&(e=ae((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.prefix!=null&&t.prefix.byteLength>0&&(r.uint32(10),r.bytes(t.prefix)),t.data!=null&&t.data.byteLength>0&&(r.uint32(18),r.bytes(t.data)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{let i={prefix:M(0),data:M(0)},a=r==null?t.len:t.pos+r;for(;t.pos<a;){let c=t.uint32();switch(c>>>3){case 1:{i.prefix=t.bytes();break}case 2:{i.data=t.bytes();break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>oe(t,n.codec()),n.decode=(t,r)=>re(t,n.codec(),r)})(ke||(ke={}));var R;(function(n){n.HaveBlock="HaveBlock",n.DontHaveBlock="DontHaveBlock"})(R||(R={}));var gt;(function(n){n[n.HaveBlock=0]="HaveBlock",n[n.DontHaveBlock=1]="DontHaveBlock"})(gt||(gt={}));(function(n){n.codec=()=>pt(gt)})(R||(R={}));var Le;(function(n){let e;n.codec=()=>(e==null&&(e=ae((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.cid!=null&&t.cid.byteLength>0&&(r.uint32(10),r.bytes(t.cid)),t.type!=null&&gt[t.type]!==0&&(r.uint32(16),R.codec().encode(t.type,r)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{let i={cid:M(0),type:R.HaveBlock},a=r==null?t.len:t.pos+r;for(;t.pos<a;){let c=t.uint32();switch(c>>>3){case 1:{i.cid=t.bytes();break}case 2:{i.type=R.codec().decode(t);break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>oe(t,n.codec()),n.decode=(t,r)=>re(t,n.codec(),r)})(Le||(Le={}));var ce;(function(n){let e;n.codec=()=>(e==null&&(e=ae((t,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),t.wantlist!=null&&(r.uint32(10),mt.codec().encode(t.wantlist,r)),t.blocks!=null)for(let i of t.blocks)r.uint32(26),ke.codec().encode(i,r);if(t.blockPresences!=null)for(let i of t.blockPresences)r.uint32(34),Le.codec().encode(i,r);t.pendingBytes!=null&&t.pendingBytes!==0&&(r.uint32(40),r.int32(t.pendingBytes)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{let i={blocks:[],blockPresences:[],pendingBytes:0},a=r==null?t.len:t.pos+r;for(;t.pos<a;){let c=t.uint32();switch(c>>>3){case 1:{i.wantlist=mt.codec().decode(t,t.uint32(),{limits:s.limits?.wantlist});break}case 3:{if(s.limits?.blocks!=null&&i.blocks.length===s.limits.blocks)throw new Ee('Decode error - map field "blocks" had too many elements');i.blocks.push(ke.codec().decode(t,t.uint32(),{limits:s.limits?.blocks$}));break}case 4:{if(s.limits?.blockPresences!=null&&i.blockPresences.length===s.limits.blockPresences)throw new Ee('Decode error - map field "blockPresences" had too many elements');i.blockPresences.push(Le.codec().decode(t,t.uint32(),{limits:s.limits?.blockPresences$}));break}case 5:{i.pendingBytes=t.int32();break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>oe(t,n.codec()),n.decode=(t,r)=>re(t,n.codec(),r)})(ce||(ce={}));function xn(n,e){for(let[t,r]of e.wantlist.entries()){let s=n.wantlist.get(t);s!=null&&(s.priority>r.priority&&(r.priority=s.priority),r.cancel=r.cancel??s.cancel,r.wantType=r.wantType??s.wantType,r.sendDontHave=r.sendDontHave??s.sendDontHave),n.wantlist.set(t,r)}for(let[t,r]of e.blockPresences.entries())n.blockPresences.set(t,r);for(let[t,r]of e.blocks.entries())n.blocks.set(t,r);return e.full&&!n.full&&(n.full=!0),n}var wt=class extends Error{static name="BlockTooLargeError";constructor(e="Block too large"){super(e),this.name="BlockTooLargeError"}};var wi=4193648,bi=wi+16;function*yn(n,e){let t=[...n.wantlist.values()],r=[...n.blockPresences.values()],s=[...n.blocks.values()],i=0,a=0,c=0,u=!1;for(;;){let p={wantlist:{full:n.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0},x=ce.encode(p).byteLength,{added:m,hasMore:A,newSize:o}=Lr(s,p.blocks,c,e,x,xi);c+=m,x=o;let l=A;({added:m,hasMore:A,newSize:o}=Lr(r,p.blockPresences,a,e,x,yi)),a+=m,x=o;let h=A;if({added:m,hasMore:A,newSize:o}=Lr(t,p.wantlist.entries,i,e,x,Ei),i+=m,x=o,u=!l&&!h&&!A,u||(p.wantlist.full=!1),yield ce.encode(p),u)break}}function Lr(n,e,t,r,s,i){let a=0,c=!1;for(let u=t;u<n.length;u++){let p=n[u],x=i(p);if(x>bi)throw new wt("Cannot send block as after encoding it is over the max message size");let m=s+x;if(m>r){c=!0;break}e.push(p),a++,s=m}return{hasMore:c,added:a,newSize:s}}function xi(n){return Sr(3,ke.encode(n))}function yi(n){return Sr(4,Le.encode(n))}function Ei(n){return Sr(1,ve.encode(n))}function Sr(n,e){let t=_(n),r=_(e.byteLength);return t+r+e.byteLength}var bt=class extends q{log;libp2p;routing;protocols;running;maxInboundStreams;maxOutboundStreams;messageReceiveTimeout;registrarIds;metrics;sendQueue;runOnLimitedConnections;maxOutgoingMessageSize;maxIncomingMessageSize;constructor(e,t={}){super(),this.log=e.logger.forComponent("helia:bitswap:network"),this.libp2p=e.libp2p,this.routing=e.routing,this.protocols=t.protocols??[Te],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=t.maxInboundStreams??1024,this.maxOutboundStreams=t.maxOutboundStreams??1024,this.messageReceiveTimeout=t.messageReceiveTimeout??5e3,this.runOnLimitedConnections=t.runOnLimitedConnections??!1,this.maxIncomingMessageSize=t.maxIncomingMessageSize??4194304,this.maxOutgoingMessageSize=t.maxOutgoingMessageSize??t.maxIncomingMessageSize??4194304,this.metrics={blocksSent:e.metrics?.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:e.metrics?.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new Ye({concurrency:t.messageSendConcurrency??50,metrics:e.metrics,metricName:"helia_bitswap_message_send_queue"}),this.sendQueue.addEventListener("error",r=>{this.log.error("error sending wantlist to peer",r.detail)})}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnections});let e={onConnect:t=>{this.safeDispatchEvent("peer:connected",{detail:t})},onDisconnect:t=>{this.safeDispatchEvent("peer:disconnected",{detail:t})}};this.registrarIds=[];for(let t of this.protocols)this.registrarIds.push(await this.libp2p.register(t,e));this.libp2p.getConnections().forEach(t=>{this.safeDispatchEvent("peer:connected",{detail:t.remotePeer})})}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),this.registrarIds!=null){for(let e of this.registrarIds)this.libp2p.unregister(e);this.registrarIds=[]}}_onStream(e){if(!this.running)return;let{stream:t,connection:r}=e;Promise.resolve().then(async()=>{this.log("incoming new bitswap %s stream from %p",t.protocol,r.remotePeer);let s=()=>{t.status==="open"?t.abort(new We(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`)):this.log("stream aborted with status %s",t.status)},i=AbortSignal.timeout(this.messageReceiveTimeout);U(1/0,i),i.addEventListener("abort",s),await t.closeWrite(),await qt(t,a=>De(a,{maxDataLength:this.maxIncomingMessageSize}),async a=>{for await(let c of a)try{let u=ce.decode(c);this.log("incoming new bitswap %s message from %p on stream",t.protocol,r.remotePeer,t.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:r.remotePeer,message:u}}),i.removeEventListener("abort",s),i=AbortSignal.timeout(this.messageReceiveTimeout),U(1/0,i),i.addEventListener("abort",s)}catch(u){this.log.error("error reading incoming bitswap message from %p on stream",r.remotePeer,t.id,u),t.abort(u);break}})}).catch(s=>{this.log.error("error handling incoming stream from %p",r.remotePeer,s),t.abort(s)})}async*findProviders(e,t){t?.onProgress?.(new V("bitswap:network:find-providers",e));for await(let r of this.routing.findProviders(e,t))await this.libp2p.isDialable(r.multiaddrs,{runOnLimitedConnection:this.runOnLimitedConnections})&&(yield r)}async findAndConnect(e,t){await Bt(Or(Vr(this.findProviders(e,t),t?.maxProviders??3),async r=>this.connectTo(r.id,t))).catch(r=>{this.log.error(r)})}async sendMessage(e,t,r){if(!this.running)throw new Error("network isn't running");let s=this.sendQueue.queue.find(i=>e.equals(i.options.peerId)&&i.status==="queued");if(s!=null){s.options.message=xn(s.options.message,t),await s.join({signal:r?.signal});return}await this.sendQueue.add(async i=>{let a=i?.message;if(a==null)throw new ue("No message to send");this.log("sendMessage to %p",e),i?.onProgress?.(new V("bitswap:network:send-wantlist",e));let c=await this.libp2p.dialProtocol(e,Te,i);await c.closeRead();try{await qt(yn(a,this.maxOutgoingMessageSize),u=>st(u),c),await c.close(i)}catch(u){i?.onProgress?.(new V("bitswap:network:send-wantlist:error",{peer:e,error:u})),this.log.error("error sending message to %p",e,u),c.abort(u)}this._updateSentStats(a.blocks)},{peerId:e,signal:r?.signal,message:t})}async connectTo(e,t){if(!this.running)throw new $e("Network isn't running");t?.onProgress?.(new V("bitswap:network:dial",e));let[r]=await Promise.all([this.libp2p.dial(e,t),O(this.libp2p,"peer:identify",t?.signal,{filter:s=>{if(!s.detail.peerId.equals(e))return!1;if(s.detail.protocols.includes(Te))return!0;throw new Ge(`${e} did not support ${Te}`)}})]);return r}_updateSentStats(e){let t=0;for(let r of e.values())t+=r.data.byteLength;this.metrics.dataSent?.increment(t),this.metrics.blocksSent?.increment(e.size)}};var le=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;var Xc=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;var Qc={}.toString;function En(n=32){if(le&&typeof le.getRandomValues=="function")return le.getRandomValues(new Uint8Array(n));if(le&&typeof le.randomBytes=="function")return le.randomBytes(n);throw new Error("crypto.getRandomValues must be defined")}function Q(n,e="utf8"){let t=ht[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(n).substring(1)}function xt(n){if(isNaN(n)||n<=0)throw new ue("random bytes length must be a Number bigger than 0");return En(n)}function yt(n,e){let t={[Symbol.iterator]:()=>t,next:()=>{let r=n.next(),s=r.value;return r.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}var Pe=class{map;constructor(e){if(this.map=new Map,e!=null)for(let[t,r]of e.entries())this.map.set(t.toString(),{key:t,value:r})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return yt(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,r)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return yt(this.map.values(),e=>e.key)}values(){return yt(this.map.values(),e=>e.value)}get size(){return this.map.size}};var Ar=class extends Pe{metric;constructor(e){super();let{name:t,metrics:r}=e;this.metric=r.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function Fe(n){let{name:e,metrics:t}=n,r;return t!=null?r=new Ar({name:e,metrics:t}):r=new Pe,r}var J=class{full;pendingBytes;wantlist;blocks;blockPresences;constructor(e=!1,t=0){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){let r=ne.encode(e.multihash.bytes);this.wantlist.set(r,t)}addBlockPresence(e,t){let r=ne.encode(e.multihash.bytes);this.blockPresences.set(r,t)}addBlock(e,t){let r=ne.encode(e.multihash.bytes);this.blocks.set(r,t)}};function Mi(n){let e=new Uint8Array(n.reduce((r,s)=>r+_(s),0)),t=0;for(let r of n)e=je(r,e,t),t+=_(r);return e}var Sn=Mi;function Dr(n){return Sn([n.version,n.code,n.multihash.code,n.multihash.digest.byteLength])}var vt=class{peerId;blockstore;network;wants;exchangeCount;bytesSent;bytesReceived;lastExchange;maxSizeReplaceHasWithBlock;log;constructor(e,t){this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??1024}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){let t=new J,r=new Set;for(let[s,i]of this.wants.entries())try{let a=await this.blockstore.get(i.cid,e);i.wantType===T.WantHave?a.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",i.cid),r.add(s),t.addBlock(i.cid,{data:a,prefix:Dr(i.cid)})):(this.log("sending have for %c",i.cid),t.addBlockPresence(i.cid,{cid:i.cid.bytes,type:R.HaveBlock})):(this.log("sending block for %c",i.cid),r.add(s),t.addBlock(i.cid,{data:a,prefix:Dr(i.cid)}))}catch(a){if(a.name!=="NotFoundError")throw a;if(this.log("do not have block for %c",i.cid),!i.sendDontHave||i.sentDontHave===!0)continue;i.sentDontHave=!0,t.addBlockPresence(i.cid,{cid:i.cid.bytes,type:R.DontHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce((s,i)=>s+i.data.byteLength,0));for(let s of r)this.wants.delete(s)}}};var kt=class{blockstore;network;ledgerMap;maxSizeReplaceHasWithBlock;log;logger;constructor(e,t={}){this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=Fe({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",r=>{this.receiveMessage(r.detail.peer,r.detail.message).catch(s=>{this.log.error("error receiving bitswap message from %p",r.detail.peer,s)})}),this.network.addEventListener("peer:disconnected",r=>{this.peerDisconnected(r.detail)})}ledgerForPeer(e){let t=this.ledgerMap.get(e);if(t!=null)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){let t=this.ledgerMap.get(e);if(t!=null)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.peerId)}async receiveMessage(e,t){let r=this.ledgerMap.get(e);if(r==null&&(r=new vt({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,r)),r.receivedBytes(t.blocks?.reduce((s,i)=>s+i.data.byteLength,0)??0),t.wantlist!=null){t.wantlist.full===!0&&r.wants.clear();for(let s of t.wantlist.entries){let i=X.decode(s.cid),a=Q(i.multihash.bytes,"base64");s.cancel===!0?(this.log("peer %p cancelled want of block for %c",e,i),r.wants.delete(a)):(s.wantType===T.WantHave?this.log("peer %p wanted block presence for %c",e,i):this.log("peer %p wanted block for %c",e,i),r.wants.set(a,{cid:i,priority:s.priority,wantType:s.wantType??T.WantBlock,sendDontHave:s.sendDontHave??!1}))}}this.log("send blocks to peer"),await r.sendBlocksToPeer()}async receivedBlock(e,t){let r=Q(e.multihash.bytes,"base64"),s=[];for(let i of this.ledgerMap.values())i.wants.has(r)&&s.push(i);await Promise.all(s.map(async i=>i.sendBlocksToPeer(t)))}peerDisconnected(e){this.ledgerMap.delete(e)}};var Ni=Br(Dn(),1);var Se;(function(n){n[n.A=1]="A",n[n.CNAME=5]="CNAME",n[n.TXT=16]="TXT",n[n.AAAA=28]="AAAA"})(Se||(Se={}));var Lt=class extends Error{static name="InsufficientProvidersError";constructor(e="Insufficient providers found"){super(e),this.name="InsufficientProvidersError"}};var Tr=Br(Ln(),1);var Ci=Math.LN2*Math.LN2,St=class n{static create(e,t=.005){let r=Ui(e,t);return new n(r)}seeds;bits;buffer;constructor(e={}){e.seeds!=null?this.seeds=e.seeds:this.seeds=Pi(e.hashes??8),this.bits=e.bits??1024,this.buffer=M(Math.ceil(this.bits/8))}add(e){typeof e=="string"&&(e=Ne(e));for(let t=0;t<this.seeds.length;t++){let s=Tr.default.x86.hash32(e,this.seeds[t])%this.bits;this.setbit(s)}}has(e){typeof e=="string"&&(e=Ne(e));for(let t=0;t<this.seeds.length;t++){let s=Tr.default.x86.hash32(e,this.seeds[t])%this.bits;if(!this.getbit(s))return!1}return!0}clear(){this.buffer.fill(0)}setbit(e){let t=0,r=e;for(;r>7;)t++,r-=8;let s=this.buffer[t];s|=1<<r,this.buffer[t]=s}getbit(e){let t=0,r=e;for(;r>7;)t++,r-=8;return(this.buffer[t]&1<<r)!==0}};function Ui(n,e=.005){let t=Math.round(-1*n*Math.log(e)/Ci),r=Math.round(t/n*Math.LN2);return{bits:t,hashes:r}}function Pi(n){let e,t,r=[];for(let s=0;s<n;s++)for(e=new K(xt(4)),r[s]=e.getUint32(0,!0),t=0;t<s;t++)if(r[s]===r[t]){s--;break}return r}var Oe=class extends q{intialPeerSearchComplete;requests;name;log;logger;minProviders;maxProviders;providers;evictionFilter;constructor(e,t){super(),U(1/0,this),this.name=t.name,this.logger=e.logger,this.log=e.logger.forComponent(this.name),this.requests=new Map,this.minProviders=t.minProviders??1,this.maxProviders=t.maxProviders??5,this.providers=[],this.evictionFilter=St.create(this.maxProviders)}async retrieve(e,t={}){let r=ne.encode(e.multihash.bytes),s=this.requests.get(r);if(s!=null)return this.log("join existing request for %c",e),s;let i=F();if(this.requests.set(r,i.promise),this.providers.length===0){let p=!1;this.intialPeerSearchComplete==null&&(p=!0,this.log=this.logger.forComponent(`${this.name}:${e}`),this.intialPeerSearchComplete=this.findProviders(e,this.minProviders,t)),await this.intialPeerSearchComplete,p&&this.log("found initial session peers for %c",e)}let a=!1,c=new de({concurrency:this.maxProviders});c.addEventListener("error",()=>{}),c.addEventListener("failure",p=>{this.log.error("error querying provider %o, evicting from session",p.detail.job.options.provider,p.detail.error),this.evict(p.detail.job.options.provider)}),c.addEventListener("success",p=>{a=!0,i.resolve(p.detail.result)}),c.addEventListener("idle",()=>{a||t.signal?.aborted===!0||Promise.resolve().then(async()=>{this.log("no session peers had block for for %c, finding new providers",e);for(let p=0;p<this.minProviders&&this.providers.length!==0;p++){let x=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(x)}await this.findProviders(e,this.minProviders,t),this.log("found new providers re-retrieving %c",e),this.requests.delete(r),i.resolve(await this.retrieve(e,t))}).catch(p=>{this.log.error("could not find new providers for %c",e,p),i.reject(p)})});let u=p=>{c.add(async()=>this.queryProvider(e,p.detail,t),{provider:p.detail}).catch(x=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c",e,x)})};this.addEventListener("provider",u),Promise.all([...this.providers].map(async p=>c.add(async()=>this.queryProvider(e,p,t),{provider:p}))).catch(p=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c",e,p)});try{return await i.promise}finally{this.removeEventListener("provider",u),c.clear(),this.requests.delete(r)}}evict(e){this.evictionFilter.add(this.toEvictionKey(e));let t=this.providers.findIndex(r=>this.equals(r,e));t!==-1&&this.providers.splice(t,1)}isEvicted(e){return this.evictionFilter.has(this.toEvictionKey(e))}hasProvider(e){return!!(this.providers.find(t=>this.equals(t,e))!=null||this.isEvicted(e))}async findProviders(e,t,r){let s=F(),i=0;return Promise.resolve().then(async()=>{this.log("finding %d-%d new provider(s) for %c",t,this.maxProviders,e);for await(let a of this.findNewProviders(e,r)){if(i===this.maxProviders||r.signal?.aborted===!0)break;if(!this.hasProvider(a)&&(this.log("found %d/%d new providers",i,this.maxProviders),this.providers.push(a),this.safeDispatchEvent("provider",{detail:a}),i++,i===t&&(this.log("session is ready"),s.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",i);break}}if(this.log("found %d/%d new session peers",i,this.maxProviders),i<t)throw new Lt(`Found ${i} of ${t} ${this.name} providers for ${e}`)}).catch(a=>{this.log.error("error searching routing for potential session peers for %c",e,a.errors??a),s.reject(a)}),s.promise}};var _r=class extends Oe{wantList;network;constructor(e,t){super(e,{...t,name:"helia:bitswap:session"}),this.wantList=e.wantList,this.network=e.network}async queryProvider(e,t,r){this.log("sending WANT-BLOCK for %c to %p",e,t);let s=await this.wantList.wantSessionBlock(e,t,r);if(this.log("%p %s %c",t,s.has?"has":"does not have",e),s.has&&s.block!=null)return s.block;throw new Error("Provider did not have block")}async*findNewProviders(e,t={}){for await(let r of this.network.findProviders(e,t))yield r.id}toEvictionKey(e){return e.toMultihash().bytes}equals(e,t){return e.equals(t)}};function Tn(n,e){return new _r(n,e)}var At=class{blocksReceived;duplicateBlocksReceived;dataReceived;duplicateDataReceived;constructor(e){this.blocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=e.metrics?.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){let r={global:e};t!=null&&(r[t.toString()]=e),this.blocksReceived?.increment(r)}updateDuplicateBlocksReceived(e=1,t){let r={global:e};t!=null&&(r[t.toString()]=e),this.duplicateBlocksReceived?.increment(r)}updateDataReceived(e,t){let r={global:e};t!=null&&(r[t.toString()]=e),this.dataReceived?.increment(r)}updateDuplicateDataReceived(e,t){let r={global:e};t!=null&&(r[t.toString()]=e),this.duplicateDataReceived?.increment(r)}};var Mr=class extends Map{metric;constructor(e){super();let{name:t,metrics:r}=e;this.metric=r.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function _n(n){let{name:e,metrics:t}=n,r;return t!=null?r=new Mr({name:e,metrics:t}):r=new Map,r}function Oi(n){if(!(n instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");let e=[];for(;n.length>0;){let t=et(n);e.push(t),n=n.slice(_(t))}return e}var Mn=Oi;var Dt=class extends q{peers;wants;network;log;sendMessagesDelay;sendMessagesTimeout;hashLoader;sendingMessages;constructor(e,t={}){super(),U(1/0,this),this.peers=Fe({name:"helia_bitswap_peers",metrics:e.metrics}),this.wants=_n({name:"helia_bitswap_wantlist",metrics:e.metrics}),this.network=e.network,this.sendMessagesDelay=t.sendMessagesDelay??10,this.log=e.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=t.hashLoader,this.network.addEventListener("bitswap:message",r=>{this.receiveMessage(r.detail.peer,r.detail.message).catch(s=>{this.log.error("error receiving bitswap message from %p",r.detail.peer,s)})}),this.network.addEventListener("peer:connected",r=>{this.peerConnected(r.detail).catch(s=>{this.log.error("error processing newly connected bitswap peer %p",r.detail,s)})}),this.network.addEventListener("peer:disconnected",r=>{this.peerDisconnected(r.detail)})}async addEntry(e,t){let r=Q(e.multihash.bytes,"base64"),s=this.wants.get(r);s==null&&(s={cid:e,priority:t.priority??1,wantType:t.wantType??T.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(r,s)),s.wantType===T.WantHave&&t.wantType===T.WantBlock&&(s.wantType=T.WantBlock),await this.sendMessagesDebounced();try{return t.wantType===T.WantBlock?(await O(this,"block",t?.signal,{filter:c=>j(e.multihash.digest,c.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await O(this,"presence",t?.signal,{filter:a=>j(e.multihash.digest,a.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{t.signal?.aborted===!0&&(this.log("want for %c was aborted, cancelling want",e),s.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){await this.sendingMessages?.promise,clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout(()=>{this.sendMessages().catch(e=>{this.log("error sending messages to peers",e)})},this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=F(),await Promise.all([...this.peers.entries()].map(async([e,t])=>{let r=new Set,s=new J;for(let[i,a]of this.wants.entries())t.has(i)||a.cancel||(r.add(i),s.addWantlistEntry(a.cid,{cid:a.cid.bytes,priority:a.priority,wantType:a.wantType,cancel:a.cancel,sendDontHave:a.sendDontHave}));if(s.wantlist.size!==0)try{await this.network.sendMessage(e,s);for(let i of r)t.add(i)}catch(i){this.log.error("error sending full wantlist to new peer",i)}})).catch(e=>{this.log.error("error sending messages",e)});for(let[e,t]of this.wants)if(t.cancel){this.wants.delete(e);for(let r of this.peers.values())r.delete(e)}this.sendingMessages.resolve()}has(e){let t=Q(e.multihash.bytes,"base64");return this.wants.has(t)}async wantSessionPresence(e,t,r={}){let s=new J;return s.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:T.WantHave,priority:1}),await this.network.sendMessage(t,s),(await O(this,"presence",r.signal,{filter:a=>t.equals(a.detail.sender)&&j(e.multihash.digest,a.detail.cid.multihash.digest)})).detail}async wantBlock(e,t={}){return this.addEntry(e,{...t,wantType:T.WantBlock})}async wantSessionBlock(e,t,r={}){let s=new J;return s.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:T.WantBlock,priority:1}),await this.network.sendMessage(t,s),(await O(this,"presence",r.signal,{filter:a=>t.equals(a.detail.sender)&&j(e.multihash.digest,a.detail.cid.multihash.digest)})).detail}async receivedBlock(e,t){let r=Q(e.multihash.bytes,"base64"),s=this.wants.get(r);s!=null&&(s.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(e,t){this.log("received message from %p with %d blocks",e,t.blocks.length);let r=!1;for(let s of t.blocks){if(s.prefix==null||s.data==null)continue;let i=Mn(s.prefix),a=i[0],c=i[1],u=i[2],p=u===ut.code?ut:await this.hashLoader?.getHasher(u);if(p==null){this.log.error("unknown hash algorithm",u);continue}let x=p.digest(s.data);x.then!=null&&(x=await x);let m=X.create(a===0?0:1,c,x);this.log("received block from %p for %c",e,m),this.safeDispatchEvent("block",{detail:{sender:e,cid:m,block:s.data}}),this.safeDispatchEvent("presence",{detail:{sender:e,cid:m,has:!0,block:s.data}});let A=Q(m.multihash.bytes,"base64"),o=this.wants.get(A);o!=null&&(o.cancel=!0,r=!0)}for(let{cid:s,type:i}of t.blockPresences){let a=X.decode(s);this.log("received %s from %p for %c",i,e,a),this.safeDispatchEvent("presence",{detail:{sender:e,cid:a,has:i===R.HaveBlock}})}r&&await this.sendMessagesDebounced()}async peerConnected(e){let t=new Set,r=new J(!0);for(let[s,i]of this.wants.entries())i.cancel||(t.add(s),r.addWantlistEntry(i.cid,{cid:i.cid.bytes,priority:1,wantType:T.WantBlock,cancel:!1,sendDontHave:!1}));if(r.wantlist.size===0){this.peers.set(e,t);return}try{await this.network.sendMessage(e,r),this.peers.set(e,t)}catch(s){this.log.error("error sending full wantlist to new peer %p",e,s)}}peerDisconnected(e){this.peers.delete(e)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}};var Tt=class{log;logger;stats;network;blockstore;peerWantLists;wantList;constructor(e,t={}){this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.stats=new At(e),this.network=new bt(e,t),this.peerWantLists=new kt({...e,network:this.network},t),this.wantList=new Dt({...e,network:this.network},t)}createSession(e={}){return Tn({wantList:this.wantList,network:this.network,logger:this.logger},e)}async want(e,t={}){let r=new AbortController,s=Nr([r.signal,t.signal]);U(1/0,r.signal,s),this.network.findAndConnect(e,{...t,signal:s}).catch(i=>{r.signal.aborted||this.log.error("error during finding and connect for cid %c",e,i)});try{return(await this.wantList.wantBlock(e,{...t,signal:s})).block}finally{r.abort(),s.clear()}}async notify(e,t,r={}){await Promise.all([this.peerWantLists.receivedBlock(e,r),this.wantList.receivedBlock(e,r)])}getWantlist(){return[...this.wantList.wants.values()].filter(e=>!e.cancel).map(e=>({cid:e.cid,priority:e.priority,wantType:e.wantType}))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}};var zi=(n,e={})=>new Tt(n,e);return Pn(Hi);})();
/*! Bundled license information:

@noble/hashes/esm/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)
*/
return HeliaBitswap}));
